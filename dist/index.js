/*!
 * auttarjs v0.2.7
 * (c) Heitor Ramon Ribeiro <heitor.ramon@gmail.com>
 * Released under the MIT License.
 */
"use strict";function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,a){for(var o=0;o<a.length;o++){var r=a[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,a,o){return a&&_defineProperties(e.prototype,a),o&&_defineProperties(e,o),e}var LogLevelName={Info:"info",Warn:"warn",Error:"error",Method:"method",All:"all",None:"none"},LogLevelStyle={Info:"background:#215ace ; padding: 2px; border-radius: 2px 0 0 2px;  color: #fff;",Warn:"background:#e8c82c ; padding: 2px; border-radius: 2px 0 0 2px;  color: #000;",Error:"background:#c92112 ; padding: 2px; border-radius: 2px 0 0 2px;  color: #fff;",Method:"background:#6d0cb2 ; padding: 2px; border-radius: 2px 0 0 2px;  color: #fff;"},NAME="Auttar ",BACKGROUND="background:#bc0909 ; padding: 2px; border-radius: 0 2px 2px 0;  color: #fff ",log=function(e,a,o,r,n){console.log("%c ".concat(e," %c ").concat(o," %c ").concat(n),a,r,"background: transparent;")},showError=function(e,a,o,r,n){console.error("%c ".concat(e," %c ").concat(o," %c ").concat(n),a,r,"background: transparent;")};function logInfo(e){log(LogLevelName.Info,LogLevelStyle.Info,NAME,BACKGROUND,e)}function logWarn(e){log(LogLevelName.Warn,LogLevelStyle.Warn,NAME,BACKGROUND,e)}function logMethod(e,a,o){log(LogLevelName.Method,LogLevelStyle.Method,NAME,BACKGROUND,"Call Method: ".concat(e,"(").concat(a||"",") ").concat(o?"=> ".concat(JSON.stringify(o)):""))}function logError(e){showError(LogLevelName.Warn,LogLevelStyle.Warn,NAME,BACKGROUND,e)}function _async(e){return function(){for(var a=[],o=0;o<arguments.length;o++)a[o]=arguments[o];try{return Promise.resolve(e.apply(this,a))}catch(e){return Promise.reject(e)}}}function _catch(e,a){try{var o=e()}catch(e){return a(e)}return o&&o.then?o.then(void 0,a):o}function _await(e,a,o){return o?a?a(e):e:(e&&e.then||(e=Promise.resolve(e)),a?e.then(a):e)}var privateVariables={transactions:{credit:{base:112,installment:113,installmentWithInterest:114},debit:{base:101,voucher:106},cancel:128,confirm:6,requestCancel:191},return:{success:0,timeOut:1,notAuthorizes:5,internetError:10,intertefError:12,error:20,ecommerceError:30},errorCodes:{5300:"Valor não informado",5301:"Cartão inválido",5302:"Cartão vencido",5303:"Data de vencimento inválido",5304:"Código de segurança inválido",5305:"Taxa de serviço excede limite",5306:"Operação não permitida",5307:"Dados inválidos",5308:"Valor mínimo da parcela inválido",5309:"Número de parcelas inválido",5310:"Número de parcelas excede limite",5311:"Valor da entrada maior ou igual ao valor da transação",5312:"Valor da parcela inválido",5313:"Data inválida",5314:"Prazo excede limite",5316:"NSU inválido",5317:"Operação cancelada pelo usuário",5318:"Documento inválido (CPF ou CNPJ)",5319:"Valor do documento inválido",5328:"Erro na captura de dados do Pin-Pad",5329:"Erro na captura do chip ou cartão removido antes da hora.",5364:"Data de emissão do cartão inválida",5355:"O tipo de financiamento informado não é coerente com o número de parcelas"},ws:null,timeout:null,close:!0,timeoutConn:null,host:"",debug:!1};function _disconnect(){privateVariables.debug&&logMethod("_disconnect"),privateVariables.ws.close(),privateVariables.debug&&logInfo("WebSocket Disconnected")}function _webSocket(e,a){return privateVariables.debug&&logMethod("_webSocket","host, payload",e,a),new Promise(function(a,o){try{privateVariables.debug&&logInfo("Starting WebSocket Connection."),null===privateVariables.ws?(privateVariables.debug&&logInfo("WebSocket not active, creating a new connection."),privateVariables.host=e,privateVariables.ws=new WebSocket(e)):2!==privateVariables.ws.readyState&&3!==privateVariables.ws.readyState||(privateVariables.debug&&logWarn("WebSocket is connected but not available. Closing connection to start a new one."),_disconnect(),privateVariables.ws=new WebSocket(e))}catch(e){o(e)}privateVariables.ws&&(privateVariables.ws.onerror=function(e){privateVariables.debug&&(logWarn("WebSocket has returned an error."),logError(e)),o(e)})})}function _send(e){return privateVariables.debug&&logMethod("_send","payload",e),new Promise(function(a,o){try{privateVariables.ws&&1===privateVariables.ws.readyState?(privateVariables.debug&&(logInfo("Sending a message to the WebSocket."),logInfo(JSON.stringify(e))),privateVariables.ws.send(JSON.stringify(e)),privateVariables.ws.onmessage=function(e){privateVariables.debug&&(logInfo("Receiving a message from the WebSocket."),logInfo(JSON.stringify(e))),a(JSON.parse(e.data))}):setTimeout(function(){_disconnect(),_webSocket(privateVariables.host,e)},5e3)}catch(e){o(e)}})}var Auttar=function(){function e(a){_classCallCheck(this,e),this.__host=a.host||"ws://localhost:2500",this.debug=a.debug||!1,privateVariables.debug=a.debug||!1,this.orderId=a.orderId||"",this.__amount=0,a.amount&&(this.amount=a.amount),this.__transactionDate=(new Date).toLocaleDateString("pt-BR",{year:"2-digit",month:"2-digit",day:"2-digit",timeZone:"America/Sao_Paulo"}).replace(/\//g,""),this.ctfTransaction={},this.__debugMessage=[]}return _createClass(e,[{key:"debugLog",value:function(e){this.debug&&logInfo(e)}},{key:"debugWarning",value:function(e){this.debug&&logWarn(e)}},{key:"debugLogMethod",value:function(e,a){if(this.debug){for(var o=arguments.length,r=new Array(o>2?o-2:0),n=2;n<o;n++)r[n-2]=arguments[n];logMethod(e,a,r)}}},{key:"classError",value:function(e){return this.debugMessage={message:e,logLevel:"error"},this.debug&&logError(e),new Error(e)}},{key:"init",value:_async(function(){var e=this;return e.debugLogMethod("init"),_catch(function(){return _await(_webSocket(e.__host),function(){return Promise.resolve(e)})},function(e){return Promise.reject(e)})})},{key:"credit",value:_async(function(){var e=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.debugLogMethod("credi","installments, withInterest",a,o),_catch(function(){var r={valorTransacao:e.amount,documento:e.orderId,operacao:privateVariables.transactions.credit.base,dataTransacao:e.__transactionDate};return a>1&&(r.operacao=privateVariables.transactions.credit.installment,r.numeroParcelas=a),a>1&&o&&(r.operacao=privateVariables.transactions.credit.installmentWithInterest,r.numeroParcelas=a),e.debugMessage={message:"Pagamento com cartão de crédito. Operação: ".concat(r.operacao,". Valor ").concat(e.amount," centavos")},_await(_send(r),function(a){if(a.retorno>0){var o=privateVariables.errorCodes[a.codigoErro]||a.display.length?a.display.map(function(e){return e.mensagem}).join(" "):" ";return Promise.reject(e.classError("Transação não concluída ".concat(a.codigoErro,": ").concat(o)))}return e.ctfTransaction=Object.assign({},a,{dataTransacao:e.__transactionDate}),Promise.resolve(a)})},function(e){return Promise.reject(e)})})},{key:"debit",value:_async(function(){var e=this,a=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return _catch(function(){return e.debugLogMethod("debit","isVoucher",a),e.debugMessage={message:"Pagamento com cartão de débito. Operação: ".concat(operacao,". Valor ").concat(e.amount," centavos")},_await(_send({valorTransacao:e.amount,documento:e.orderId,dataTransacao:e.__transactionDate,operacao:a?privateVariables.transactions.debit.voucher:privateVariables.transactions.debit.base}),function(a){if(a.retorno>0){var o=privateVariables.errorCodes[a.codigoErro]||a.display.length?a.display.map(function(e){return e.mensagem}).join(" "):" ";return Promise.reject(e.classError("Transação não concluída ".concat(a.codigoErro,": ").concat(o)))}return e.ctfTransaction=Object.assign({},a,{dataTransacao:e.__transactionDate}),Promise.resolve(a)})},function(e){return Promise.reject(e)})})},{key:"confirm",value:_async(function(){var e=this;return _catch(function(){return e.debugLogMethod("confirm"),_await(_send({operacao:privateVariables.transactions.confirm}),function(a){if(e.debugMessage={message:"Confirmação de pagamento da operação realizada.\n      Operação: ".concat(e.ctfTransaction.operacao,"\n      Data: ").concat(e.ctfTransaction.dataTransacao,"\n      Valor: ").concat(e.amount,"\n      Bandeira: ").concat(e.ctfTransaction.bandeira,"\n      Cartão: ").concat(e.ctfTransaction.cartao)},a.retorno>0){var o=privateVariables.errorCodes[a.codigoErro]||a.display.length?a.display.map(function(e){return e.mensagem}).join(" "):" ";return Promise.reject(e.classError("Transação não concluída ".concat(a.codigoErro,": ").concat(o)))}return e.ctfTransaction=Object.assign(e.ctfTransaction,a),Promise.resolve(a)})},function(e){return Promise.reject(e)})})},{key:"requestCancellation",value:_async(function(){var e=this;return _catch(function(){return e.debugLogMethod("requestCancellation"),e.debugMessage={message:"Requisição de cancelamento de compra.\n      Operação: ".concat(e.ctfTransaction.operacao,"\n      Data: ").concat(e.ctfTransaction.dataTransacao,"\n      Valor: ").concat(e.amount,"\n      NSU: ").concat(e.ctfTransaction.nsuCTF)},_await(_send({operacao:privateVariables.transactions.requestCancel}),function(a){if(a.retorno>0){var o=privateVariables.errorCodes[a.codigoErro]||a.display.length?a.display.map(function(e){return e.mensagem}).join(" "):" ";return Promise.reject(e.classError("Transação não concluída ".concat(a.codigoErro,": ").concat(o)))}return Promise.resolve(a)})},function(e){return Promise.reject(e)})})},{key:"cancel",value:_async(function(){var e=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _catch(function(){e.debugLogMethod("cancel","prop",a);var o=privateVariables.transactions.cancel,r=a.operacao||e.ctfTransaction.operacao,n=a.dataTransacao||e.ctfTransaction.dataTransacao,t=a.amount?100*parseFloat(a.amount):e.ctfTransaction.valorTransacao,i=a.nsuCTF||e.ctfTransaction.nsuCTF;return e.debugMessage={message:"Cancelamento de compra.\n        Operação: ".concat(r,"\n        Data: ").concat(n,"\n        Valor: ").concat(t,"\n        NSU: ").concat(i)},_await(_send({operacao:o,valorTransacao:t,dataTransacao:n,nsuCTF:i}),function(a){if(a.retorno>0){var o=privateVariables.errorCodes[a.codigoErro]||a.display[0].mensagem;return Promise.reject(e.classError("Transação não concluída ".concat(a.codigoErro,": ").concat(o)))}})},function(e){return Promise.reject(e)})})},{key:"debugMessage",get:function(){return this.__debugMessage},set:function(e){if(this.debug){var a=Object.assign({logLevel:"info",message:""},e,{date:(new Date).toISOString()});if("log"===a.logLevel&&a.message)return this.debugLog(a.message);this.__debugMessage.push(Object.assign({},a,{date:(new Date).toISOString()})),"info"===a.logLevel&&a.message&&this.debugLog(a.message)}}},{key:"amount",get:function(){return this.__amount},set:function(e){if("number"==typeof e&&e<=0)throw new Error("Não é possível definir um valor menor ou igual a zero.");this.__amount=100*parseFloat(e)}}]),e}();module.exports=Auttar;
//# sourceMappingURL=index.js.map
